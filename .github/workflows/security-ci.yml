name: Security CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ”¹ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ”¹ Instalar dependÃªncias
        run: |
          cd fyora-app
          npm ci

      - name: ðŸ”¹ Rodar testes automatizados (unitÃ¡rios)
        run: |
          cd fyora-app
          npm test -- --ci --coverage

      - name: ðŸ”¹ Rodar SAST (Semgrep via Docker)
        run: |
          cd fyora-app
          docker run --rm -v "$(pwd):/src" returntocorp/semgrep semgrep \
            --config /src/.semgrep/rules /src --json > reports/semgrep/semgrep.json

      - name: ðŸ”¹ Rodar script de seguranÃ§a local (SCA + DAST)
        run: |
          cd fyora-app
          chmod +x scripts/run-security-checks.sh
          ./scripts/run-security-checks.sh

      - name: ðŸ”¹ Fazer upload dos relatÃ³rios
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: fyora-app/reports/
